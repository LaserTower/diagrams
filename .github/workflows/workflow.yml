name: Upload Changed Files to AnythingLLM (with folder structure)

on:
  push:
    branches:
      - main

jobs:
  upload-documents:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Sync files
        id: changed-files
        run: |
          for file in $(git diff --name-only HEAD~1 HEAD); do
            filename=$(basename "$file")
            workplace=$(basename $(dirname "$file"))
            api_url="https://anythingllm.gto-stat.ru/api/v1"
            json=$(curl -X POST $api_url/document/upload/workplace \
              -H "Authorization: Bearer ${{ secrets.ANYTHINGLLM_API_KEY }}" \
              -F "file=@$file" \
              --fail-with-body)
              echo "$json" | jq '.'
            
              curl -X POST $api_url/workspace/lighthouse/update-embeddings \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.ANYTHINGLLM_API_KEY }}" 
               -d "{\"deletes\": [\"$filename\"]}"
               
              curl -X POST $api_url/workspace/lighthouse/update-embeddings \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.ANYTHINGLLM_API_KEY }}" \
              -d "{\"adds\": [\"$filename\"]}"
          done
